"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[922],{7922:(e,t,r)=>{r.r(t),r.d(t,{default:()=>y});var o=r(95155),a=r(12115),s=r(71482),n=r(49941),i=r(95535),l=r(33434);r(44669);let d={喜び:"\uD83D\uDE0A",楽しさ:"\uD83C\uDF89",悲しみ:"\uD83D\uDE22",焦り:"\uD83D\uDE30",不安:"\uD83D\uDE1F",心配:"\uD83D\uDE14",満足感:"\uD83D\uDE0C",集中:"\uD83C\uDFAF",疲労:"\uD83D\uDE2B",怒り:"\uD83D\uDE20",感謝:"\uD83D\uDE4F",期待:"✨",平穏:"☺️"};var c=r(65229),g=r(18085),m=r(37586);let h={reflection:{icon:"\uD83E\uDD14",bgColor:"from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20",borderColor:"border-purple-200 dark:border-purple-700",hoverBg:"hover:from-purple-100 hover:to-pink-100"},detail:{icon:"\uD83D\uDD0D",bgColor:"from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20",borderColor:"border-green-200 dark:border-green-700",hoverBg:"hover:from-green-100 hover:to-emerald-100"},emotion:{icon:"\uD83D\uDCAD",bgColor:"from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20",borderColor:"border-yellow-200 dark:border-yellow-700",hoverBg:"hover:from-yellow-100 hover:to-orange-100"},action:{icon:"\uD83C\uDFAF",bgColor:"from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20",borderColor:"border-blue-200 dark:border-blue-700",hoverBg:"hover:from-blue-100 hover:to-cyan-100"}},p={diaryNode:function(e){let{data:t}=e,[r,n]=(0,a.useState)(!1),i=r?t.content:t.content.length>100?t.content.substring(0,100)+"...":t.content;return(0,o.jsxs)("div",{className:"bg-gradient-to-br ".concat((()=>{let e=t.emotionScore||3;return e>=4?"from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20":e>=3?"from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20":e>=2?"from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20":"from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20"})()," rounded-xl shadow-lg border ").concat((()=>{let e=t.emotionScore||3;return e>=4?"border-green-200 dark:border-green-700":e>=3?"border-blue-200 dark:border-blue-700":e>=2?"border-yellow-200 dark:border-yellow-700":"border-red-200 dark:border-red-700"})()," p-4 min-w-[280px] max-w-[400px] cursor-pointer transition-all hover:shadow-xl"),onClick:()=>n(!r),children:[(0,o.jsx)(s.h7,{type:"source",position:s.yX.Right,className:"w-3 h-3 bg-blue-500"}),(0,o.jsxs)("div",{className:"space-y-3",children:[(0,o.jsx)("div",{className:"flex justify-between items-start",children:(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsx)("div",{className:"text-2xl",children:"\uD83D\uDCD6"}),(0,o.jsxs)("div",{children:[(0,o.jsx)("h3",{className:"font-bold text-gray-800 dark:text-gray-100",children:"今日の日記"}),(0,o.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:t.date})]})]})}),t.emotions.length>0&&(0,o.jsx)("div",{className:"flex gap-1 flex-wrap",children:t.emotions.map((e,t)=>(0,o.jsx)("span",{className:"text-lg",title:e,children:d[e]||"\uD83D\uDCAD"},t))}),(0,o.jsx)("div",{className:"text-sm text-gray-700 dark:text-gray-300 leading-relaxed",children:i}),t.content.length>100&&(0,o.jsx)("button",{className:"text-xs text-blue-600 dark:text-blue-400 hover:underline",children:r?"折りたたむ":"全文を読む"}),t.keywords.length>0&&(0,o.jsx)("div",{className:"flex gap-1 flex-wrap",children:t.keywords.slice(0,3).map((e,t)=>(0,o.jsx)("span",{className:"text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-full",children:e},t))})]})]})},integratedQuestionNode:function(e){let{data:t}=e,[r,n]=(0,a.useState)(!1),[i,l]=(0,a.useState)(""),[d,p]=(0,a.useState)(!1),{getNodes:y,setNodes:u,getEdges:x,setEdges:b}=(0,s.VH)(),f=(0,s.FC)(),w=h[t.category]||h.reflection,k=async()=>{if(i.trim()&&f&&!d){p(!0),console.log("Submitting answer:",i);try{let e=await fetch("/api/ai/answer-analysis",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({answer:i,originalQuestion:t.question,diaryContent:"日記の内容"})}),r=await e.json();console.log("API Response:",r);let o=y();x();let a=o.find(e=>e.id===f);if(a){let e=[],t=[];if(r.followUpQuestions){let s=o.map(e=>({x:e.position.x,y:e.position.y}));r.followUpQuestions.slice(0,2).forEach((r,o)=>{let n="question-".concat(f,"-").concat(o,"-").concat(Date.now()),i=a.position.x+450,l=a.position.y+250*o-125;s.some(e=>100>Math.abs(e.x-i)&&100>Math.abs(e.y-l))&&(i+=150,l+=50*o),e.push({id:n,type:"integratedQuestionNode",position:{x:i,y:l},data:{question:r.question,category:r.category||"reflection",answered:!1}}),t.push({id:"edge-".concat(f,"-").concat(n),source:f,target:n,type:"smoothstep",animated:!0,style:{strokeWidth:2,stroke:"#10b981"}})})}u(t=>[...t.map(e=>e.id===f?{...e,data:{...e.data,answered:!0,answer:i,emotions:r.emotions,keywords:r.keywords}}:e),...e]),t.length>0&&b(e=>[...e,...t])}n(!1),l("")}catch(e){console.error("Error submitting answer:",e)}finally{p(!1)}}};return(0,o.jsxs)("div",{className:"bg-gradient-to-br ".concat(w.bgColor," ").concat(!t.answered&&!r?w.hoverBg:""," rounded-xl shadow-md border ").concat(w.borderColor," p-4 min-w-[280px] max-w-[380px] transition-all hover:shadow-lg"),children:[(0,o.jsx)(s.h7,{type:"target",position:s.yX.Left,className:"w-3 h-3 bg-gray-400"}),(0,o.jsx)(s.h7,{type:"source",position:s.yX.Right,className:"w-3 h-3 bg-gray-400"}),(0,o.jsxs)("div",{className:"space-y-3",children:[(0,o.jsxs)("div",{className:"flex items-start gap-3",children:[(0,o.jsx)("div",{className:"text-2xl flex-shrink-0",children:w.icon}),(0,o.jsx)("div",{className:"flex-1",children:(0,o.jsx)("p",{className:"text-sm font-medium text-gray-800 dark:text-gray-100 leading-relaxed",children:t.question})})]}),t.answered&&t.answer&&(0,o.jsxs)("div",{className:"bg-white/50 dark:bg-gray-800/50 rounded-lg p-3 space-y-2",children:[(0,o.jsx)("p",{className:"text-xs text-gray-600 dark:text-gray-400 font-medium",children:"あなたの回答:"}),(0,o.jsx)("p",{className:"text-sm text-gray-700 dark:text-gray-300",children:t.answer}),t.emotions&&t.emotions.length>0&&(0,o.jsx)("div",{className:"flex gap-1 flex-wrap mt-2",children:t.emotions.map((e,t)=>(0,o.jsx)("span",{className:"text-xs bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-300 px-2 py-0.5 rounded-full",children:e},t))})]}),r&&!t.answered&&(0,o.jsxs)("div",{className:"space-y-2",children:[(0,o.jsx)("textarea",{value:i,onChange:e=>l(e.target.value),placeholder:"この質問について考えてみましょう...",className:"w-full px-3 py-2 text-sm bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none",rows:3,autoFocus:!0,disabled:d}),(0,o.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,o.jsxs)("button",{onClick:()=>{n(!1),l("")},disabled:d,className:"px-3 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors disabled:opacity-50",children:[(0,o.jsx)(c.A,{className:"w-3 h-3 inline mr-1"}),"キャンセル"]}),(0,o.jsxs)("button",{onClick:k,disabled:!i.trim()||d,className:"px-3 py-1 text-xs bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[(0,o.jsx)(g.A,{className:"w-3 h-3 inline mr-1"}),d?"送信中...":"送信"]})]})]}),!r&&!t.answered&&(0,o.jsxs)("button",{onClick:()=>n(!0),className:"w-full mt-2 px-3 py-2 text-xs bg-white/50 dark:bg-gray-800/50 text-gray-600 dark:text-gray-400 rounded-lg hover:bg-white/70 dark:hover:bg-gray-800/70 transition-colors flex items-center justify-center gap-2",children:[(0,o.jsx)(m.A,{className:"w-3 h-3"}),"回答を入力"]})]})]})}};function y(e){let{diaryId:t}=e,[r,d,c]=(0,s.ck)([]),[g,m,h]=(0,s.fM)([]),[y,u]=(0,a.useState)(null),[x,b]=(0,a.useState)(()=>{{let e=sessionStorage.getItem("aiCache");if(e)try{let t=JSON.parse(e);return new Map(Object.entries(t))}catch(e){console.error("キャッシュの読み込みエラー:",e)}}return new Map}),f=(0,a.useMemo)(()=>(console.log("NodeTypes registration:",p),p),[]),w=(0,a.useCallback)(e=>m(t=>(0,s.rN)(e,t)),[m]);(0,a.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/diary");if(e.ok){let r=await e.json();if(console.log("取得した日記一覧:",r),t){let e=r.find(e=>e.id===t);console.log("選択された日記:",e),e&&(u(e),k(e))}else if(r.length>0){let e=r[0];u(e),k(e)}}}catch(e){console.error("日記データの取得に失敗:",e)}})()},[t]);let k=async e=>{console.log("マインドマップ生成開始:",e);let t=[],r=[];try{let o,a,n="".concat(e.id,"_").concat(e.entryDate);if(x.has(n)){let e=x.get(n);o=e.questionsData,a=e.emotionsData,console.log("キャッシュから AI データを使用")}else{let[t,r]=await Promise.all([fetch("/api/ai/questions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:e.content})}),fetch("/api/ai/emotions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:e.content})})]);o=await t.json(),a=await r.json();let s=new Map(x);s.set(n,{questionsData:o,emotionsData:a}),b(s);{let e=Object.fromEntries(s);sessionStorage.setItem("aiCache",JSON.stringify(e))}console.log("新しい AI データを生成してキャッシュに保存")}console.log("AI API レスポンス:",{questionsData:o,emotionsData:a});let i=a.success?a.emotions.dominantEmotions||[]:["平穏"],l=a.success&&a.keywords||[],d={id:"diary-1",type:"diaryNode",position:{x:50,y:200},data:{content:e.content,emotions:i,keywords:l.slice(0,5),date:new Date(e.entryDate).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"}),emotionScore:a.success?a.emotions.overallScore:3}};t.push(d),(o.success?o.questions.slice(0,2):[{question:"今日の出来事から学んだことは何ですか？",category:"reflection"},{question:"明日はどんな1日にしたいですか？",category:"action"}]).forEach((e,o)=>{let a={id:"question-".concat(o+1),type:"integratedQuestionNode",position:{x:500,y:100+200*o},data:{question:e.question,category:e.category,answered:!1}};t.push(a),r.push({id:"edge-diary-question-".concat(o+1),source:"diary-1",target:"question-".concat(o+1),type:"smoothstep",animated:!1,markerEnd:{type:s.TG.ArrowClosed,width:15,height:15,color:"#94a3b8"},style:{strokeWidth:2,stroke:"#94a3b8"}})}),console.log("生成されたノード数:",t.length),console.log("生成されたエッジ数:",r.length)}catch(o){console.error("AI API呼び出しエラー:",o);let r={id:"diary-1",type:"diaryNode",position:{x:50,y:200},data:{content:e.content,emotions:["平穏"],keywords:[],date:new Date(e.entryDate).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"})}};t.push(r)}d(t),m(r)};return(0,o.jsx)("div",{className:"w-full h-full",style:{minHeight:"600px",height:"100vh"},children:(0,o.jsxs)(s.Gc,{nodes:r,edges:g,onNodesChange:c,onEdgesChange:h,onConnect:w,nodeTypes:f,fitView:!0,fitViewOptions:{padding:.2,includeHiddenNodes:!1},attributionPosition:"bottom-left",minZoom:.1,maxZoom:2,defaultViewport:{x:0,y:0,zoom:.8},proOptions:{hideAttribution:!0},children:[(0,o.jsx)(n.V,{color:"#e5e7eb",gap:20,variant:"dots",style:{backgroundColor:"#f9fafb"}}),(0,o.jsx)(i.H,{showInteractive:!1}),(0,o.jsx)(l.o,{nodeColor:"#3b82f6",nodeStrokeWidth:3,zoomable:!0,pannable:!0})]})})}},18085:(e,t,r)=>{r.d(t,{A:()=>o});let o=(0,r(71847).A)("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]])},37586:(e,t,r)=>{r.d(t,{A:()=>o});let o=(0,r(71847).A)("message-square",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]])},65229:(e,t,r)=>{r.d(t,{A:()=>o});let o=(0,r(71847).A)("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])},71847:(e,t,r)=>{r.d(t,{A:()=>l});var o=r(12115);let a=e=>{let t=e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,r)=>r?r.toUpperCase():t.toLowerCase());return t.charAt(0).toUpperCase()+t.slice(1)},s=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter((e,t,r)=>!!e&&""!==e.trim()&&r.indexOf(e)===t).join(" ").trim()};var n={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let i=(0,o.forwardRef)((e,t)=>{let{color:r="currentColor",size:a=24,strokeWidth:i=2,absoluteStrokeWidth:l,className:d="",children:c,iconNode:g,...m}=e;return(0,o.createElement)("svg",{ref:t,...n,width:a,height:a,stroke:r,strokeWidth:l?24*Number(i)/Number(a):i,className:s("lucide",d),...!c&&!(e=>{for(let t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0})(m)&&{"aria-hidden":"true"},...m},[...g.map(e=>{let[t,r]=e;return(0,o.createElement)(t,r)}),...Array.isArray(c)?c:[c]])}),l=(e,t)=>{let r=(0,o.forwardRef)((r,n)=>{let{className:l,...d}=r;return(0,o.createElement)(i,{ref:n,iconNode:t,className:s("lucide-".concat(a(e).replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()),"lucide-".concat(e),l),...d})});return r.displayName=a(e),r}}}]);